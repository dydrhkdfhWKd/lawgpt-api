# -*- coding: utf-8 -*-
"""Untitled3.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1DEmDEvChjjLAZQs3LqTp0K0m0iGmb9QF
"""

@app.route('/law_search', methods=['GET'])
def law_search():
    query = request.args.get('query')
    clause_filter = request.args.get('clause')  # ex: "제1조"

    if not query:
        return Response(json.dumps({"error": "No query provided"}, ensure_ascii=False),
                        content_type="application/json; charset=utf-8")

    try:
        encoded_query = quote(query)
        url = f"http://www.law.go.kr/DRF/lawSearch.do?target=admrul&OC=gogohakj1558&type=XML&query={encoded_query}"
        response = urlopen(url).read()
        xtree = ET.fromstring(response)

        results = []
        for i in xtree[8:]:
            law_id = i[0].text
            law_url = f"http://www.law.go.kr/DRF/lawService.do?OC=gogohakj1558&target=admrul&ID={law_id}&type=XML"
            law_response = urlopen(law_url).read()
            law_tree = ET.fromstring(law_response)

            for clause in law_tree[1:]:
                if clause.tag == "조문내용" and clause.text:
                    if clause_filter:
                        if clause_filter in clause.text:
                            results.append({
                                "title": law_tree[0][1].text,
                                "content": clause.text
                            })
                    else:
                        results.append({
                            "title": law_tree[0][1].text,
                            "content": clause.text
                        })

                # ✅ 응답 결과 너무 클 경우 제한 (예: 50개)
                if len(results) >= 50:
                    break

        return Response(json.dumps(results, ensure_ascii=False), content_type="application/json; charset=utf-8")

    except Exception as e:
        return Response(json.dumps(
            {"error": "예기치 못한 오류", "details": repr(e)},
            ensure_ascii=False
        ), content_type="application/json; charset=utf-8")