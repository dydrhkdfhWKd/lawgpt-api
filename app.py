# -*- coding: utf-8 -*-
"""Untitled3.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1DEmDEvChjjLAZQs3LqTp0K0m0iGmb9QF
"""

from flask import Flask, request, Response
import xml.etree.ElementTree as ET
from urllib.request import urlopen
from urllib.parse import quote
import json

app = Flask(__name__)

@app.route('/')
def home():
    return "ğŸ”¥ LawGPT ì„œë²„ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"

@app.route('/law_search', methods=['GET'])
def law_search():
    query = request.args.get('query')
    if not query:
        return Response(json.dumps({"error": "ì¿¼ë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."}, ensure_ascii=False),
                        content_type="application/json; charset=utf-8")

    try:
        # âœ… í‚¤ì›Œë“œ ë¶„ë¦¬
        keywords = query.strip().split()
        if not keywords:
            raise ValueError("ì¿¼ë¦¬ì— í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.")

        encoded_query = quote(' '.join(keywords))

        # ğŸ” ë¬¸ì„œ ê²€ìƒ‰
        url = f"http://www.law.go.kr/DRF/lawSearch.do?target=admrul&OC=gogohakj1558&type=XML&query={encoded_query}"
        response = urlopen(url).read()
        xtree = ET.fromstring(response)

        results = []

        for item in xtree.findall("admrul"):
            law_id = item.findtext("í–‰ì •ê·œì¹™ì¼ë ¨ë²ˆí˜¸")
            if not law_id:
                continue

            # ğŸ” ìƒì„¸ ì¡°íšŒ
            detail_url = f"http://www.law.go.kr/DRF/lawService.do?OC=gogohakj1558&target=admrul&ID={law_id}&type=XML"
            detail_response = urlopen(detail_url).read()
            detail_tree = ET.fromstring(detail_response)

            # ì œëª©ê³¼ ì „ì²´ ì¡°ë¬¸ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
            title = detail_tree.findtext("í–‰ì •ê·œì¹™ê¸°ë³¸ì •ë³´/í–‰ì •ê·œì¹™ëª…", default="ì œëª© ì—†ìŒ")

            # âœ… ì—¬ëŸ¬ ê°œì˜ <ì¡°ë¬¸ë‚´ìš©>ì„ ëª¨ë‘ ê²°í•©
            content_nodes = detail_tree.findall("ì¡°ë¬¸ë‚´ìš©")
            combined_content = "\n\n".join([node.text.strip() for node in content_nodes if node.text])

            if not combined_content:
                continue

            # âœ… í‚¤ì›Œë“œê°€ ëª¨ë‘ í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if all(k in combined_content for k in keywords[1:]):
                results.append({
                    "title": title,
                    "content": combined_content
                })

        if not results:
            return Response(json.dumps({"message": "í•´ë‹¹ í‚¤ì›Œë“œë¥¼ í¬í•¨í•œ ì¡°ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}, ensure_ascii=False),
                            content_type="application/json; charset=utf-8")

        return Response(json.dumps(results, ensure_ascii=False, indent=2),
                        content_type="application/json; charset=utf-8")

    except Exception as e:
        return Response(json.dumps({
            "error": "ì˜ˆê¸°ì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
            "details": str(e)
        }, ensure_ascii=False),
            content_type="application/json; charset=utf-8")