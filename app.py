# -*- coding: utf-8 -*-
"""Untitled3.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1DEmDEvChjjLAZQs3LqTp0K0m0iGmb9QF
"""

from flask import Flask, request, jsonify
import xml.etree.ElementTree as ET
from urllib.request import urlopen
from urllib.error import URLError, HTTPError

app = Flask(__name__)

@app.route('/')
def home():
    return "ğŸ”¥ LawGPT ì„œë²„ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"

@app.route('/law_search', methods=['GET'])
def law_search():
    query = request.args.get('query')
    if not query:
        return jsonify({"error": "No query provided"}), 400

    try:
        url = f"http://www.law.go.kr/DRF/lawSearch.do?target=admrul&OC=gogohakj1558&type=XML&query={query}"
        response = urlopen(url).read()
        xtree = ET.fromstring(response)

        # í˜ì´ì§€ ìˆ˜ í™•ì¸ (4ë²ˆì§¸ ìš”ì†Œì— ì „ì²´ ê±´ìˆ˜ ìˆìŒ)
        try:
            total_count = int(xtree[3].text)
        except (IndexError, ValueError):
            return jsonify({"error": "ë²•ë ¹ ê²€ìƒ‰ ê²°ê³¼ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."}), 500

        total_pages = (total_count // 20) + 1

        adm_num = []

        # ëª¨ë“  í˜ì´ì§€ ìˆœíšŒí•˜ë©´ì„œ ì¼ë ¨ë²ˆí˜¸ ìˆ˜ì§‘
        for page_num in range(1, total_pages + 1):
            page_url = f"http://www.law.go.kr/DRF/lawSearch.do?target=admrul&OC=gogohakj1558&type=XML&query={query}&page={page_num}"
            page_response = urlopen(page_url).read()
            page_tree = ET.fromstring(page_response)
            for i in page_tree[8:]:
                adm_num.append(i[0].text)

        results = []

        # ê° ì¼ë ¨ë²ˆí˜¸ë¡œ ë³¸ë¬¸ ìš”ì²­
        for num in adm_num:
            law_url = f"http://www.law.go.kr/DRF/lawService.do?OC=gogohakj1558&target=admrul&ID={num}&type=XML"
            law_response = urlopen(law_url).read()
            law_tree = ET.fromstring(law_response)

            for clause in law_tree[1:]:
                if clause.tag == "ì¡°ë¬¸ë‚´ìš©" and clause.text:
                    results.append({
                        "title": law_tree[0][1].text,
                        "content": clause.text
                    })

        return jsonify(results if results else {"message": "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."})

    except HTTPError as e:
        return jsonify({"error": f"HTTP ì˜¤ë¥˜: {e.code}"}), 500
    except URLError as e:
        return jsonify({"error": f"URL ì—°ê²° ì˜¤ë¥˜: {e.reason}"}), 500
    except Exception as e:
        return jsonify({"error": f"ì˜ˆê¸°ì¹˜ ëª»í•œ ì˜¤ë¥˜: {str(e)}"}), 500

# ì„œë²„ ì‹¤í–‰ìš© (Railwayì—ì„œ í•„ìš”)
if __name__ == "__main__":
    import os
    port = int(os.environ.get("PORT", 5000))
    app.run(host='0.0.0.0', port=port)