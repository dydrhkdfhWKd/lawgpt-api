# -*- coding: utf-8 -*-
"""Untitled3.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1DEmDEvChjjLAZQs3LqTp0K0m0iGmb9QF
"""

from flask import Flask, request, Response
import xml.etree.ElementTree as ET
from urllib.request import urlopen
from urllib.parse import quote
import json

app = Flask(__name__)

@app.route('/')
def home():
    return "ğŸ”¥ LawGPT ì„œë²„ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"

@app.route('/law_search', methods=['GET'])
def law_search():
    query = request.args.get('query')
    if not query:
        return Response(json.dumps({"error": "ì¿¼ë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."}, ensure_ascii=False),
                        content_type="application/json; charset=utf-8")

    try:
        # âœ… í‚¤ì›Œë“œ ë¶„ë¦¬
        keywords = query.strip().split()
        if not keywords:
            raise ValueError("ì¿¼ë¦¬ì— í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.")

        # âœ… ëª¨ë“  í‚¤ì›Œë“œë¥¼ ë¬¸ì„œ ê²€ìƒ‰ì— í™œìš©
        encoded_query = quote(' '.join(keywords))

        # ğŸ” ë¬¸ì„œ ê²€ìƒ‰ (ë¬¸ì„œëª…ì— í•˜ë‚˜ë¼ë„ í‚¤ì›Œë“œ í¬í•¨ëœ ë¬¸ì„œ ëª¨ë‘ ì¡°íšŒ)
        url = f"http://www.law.go.kr/DRF/lawSearch.do?target=admrul&OC=gogohakj1558&type=XML&query={encoded_query}"
        response = urlopen(url).read()
        xtree = ET.fromstring(response)

        results = []
        for item in xtree.findall("ë²•ë ¹"):
            law_id = item.findtext("ë²•ë ¹ID")
            if not law_id:
                continue

            # ğŸ§¾ ì¡°ë¬¸ ìƒì„¸ ì¡°íšŒ
            law_url = f"http://www.law.go.kr/DRF/lawService.do?OC=gogohakj1558&target=admrul&ID={law_id}&type=XML"
            law_response = urlopen(law_url).read()
            law_tree = ET.fromstring(law_response)

            law_title = law_tree.findtext("ë²•ë ¹ëª…í•œê¸€", default="ì•Œ ìˆ˜ ì—†ìŒ")

            for clause in law_tree.findall(".//ì¡°ë¬¸ë‚´ìš©"):
                if clause.text:
                    text = clause.text.strip()
                    # âœ… í‚¤ì›Œë“œ ëª¨ë‘ í¬í•¨ëœ ì¡°ë¬¸ë§Œ ì¶”ì¶œ (ì²« í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€ëŠ” ì œì™¸)
                    if all(k in text for k in keywords[1:]):
                        results.append({
                            "title": law_title,
                            "content": text
                        })

        if not results:
            return Response(json.dumps({"message": "í•´ë‹¹ í‚¤ì›Œë“œë¥¼ í¬í•¨í•œ ì¡°ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}, ensure_ascii=False),
                            content_type="application/json; charset=utf-8")

        return Response(json.dumps(results, ensure_ascii=False),
                        content_type="application/json; charset=utf-8")

    except Exception as e:
        return Response(json.dumps({
            "error": "ì˜ˆê¸°ì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
            "details": str(e)
        }, ensure_ascii=False),
            content_type="application/json; charset=utf-8")