# -*- coding: utf-8 -*-
"""Untitled3.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1DEmDEvChjjLAZQs3LqTp0K0m0iGmb9QF
"""

from flask import Flask, request, jsonify
import xml.etree.ElementTree as ET
from urllib.request import urlopen
from urllib.parse import quote

app = Flask(__name__)

def law_search(query):
    if not query:
        return {"error": "쿼리를 입력해주세요."}

    try:
        keywords = query.strip().split()
        if not keywords:
            raise ValueError("쿼리에 키워드가 없습니다.")

        first_keyword = keywords[0]  # 문서명에서 찾을 키워드
        remaining_keywords = keywords[1:]  # 조문 내용에서 찾을 키워드

        encoded_query = quote(first_keyword)
        results = []
        max_results = 10
        page = 1

        while len(results) < max_results:
            url = f"http://www.law.go.kr/DRF/lawSearch.do?target=admrul&OC=gogohakj1558&type=XML&query={encoded_query}&display=1&page={page}"

            try:
                response = urlopen(url, timeout=5).read()
                xtree = ET.fromstring(response)
            except Exception:
                page += 1
                continue  # 요청 실패 시 다음 페이지로

            admrul_list = xtree.findall("admrul")
            if not admrul_list:
                break  # 더 이상 문서 없음

            item = admrul_list[0]
            law_id = item.findtext("행정규칙일련번호")
            if not law_id:
                page += 1
                continue

            detail_url = f"http://www.law.go.kr/DRF/lawService.do?OC=gogohakj1558&target=admrul&ID={law_id}&type=XML"
            try:
                detail_response = urlopen(detail_url, timeout=5).read()
                detail_tree = ET.fromstring(detail_response)
            except Exception:
                page += 1
                continue  # 해당 문서 로딩 실패 시 패스

            title = detail_tree.findtext("행정규칙기본정보/행정규칙명", default="제목 없음")
            if first_keyword not in title:
                page += 1
                continue

            content_nodes = detail_tree.findall("조문내용")
            filtered_clauses = [
                node.text.strip()
                for node in content_nodes
                if node.text and all(k in node.text for k in remaining_keywords)
            ]

            if not filtered_clauses:
                page += 1
                continue  # 해당 문서에서 조건 맞는 조문 없음

            combined_content = "\n\n".join(filtered_clauses)
            results.append({
                "title": title,
                "content": combined_content
            })

            page += 1  # 다음 문서로 이동

        if not results:
            return {"message": "해당 키워드를 포함한 조문을 찾을 수 없습니다."}

        return results

    except Exception as e:
        return {
            "error": "예기치 못한 오류가 발생했습니다.",
            "details": str(e)
        }

@app.route('/law_search')
def law_search_route():
    query = request.args.get('query', '')
    result = law_search(query)
    return jsonify(result)

if __name__ == '__main__':
    app.run(debug=True)